name: C++ CI/CD with Qt5

on: [push, pull_request]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Установка Qt5
        uses: jurplel/install-qt-action@v3
        with:
          version: "5.15.2"
          host: ${{ matrix.os == 'ubuntu-latest' && 'linux' || matrix.os == 'windows-latest' && 'windows' || 'macos' }}
          target: desktop

      - name: Установка зависимостей (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential
          sudo apt-get install -y libgl1-mesa-dev

      - name: Конфигурация проекта
        run: |
          mkdir -p build
          cd build
          qmake ../StringOperations.pro

      - name: Сборка проекта
        run: |
          cd build
          if [ "$RUNNER_OS" = "Windows" ]; then
            nmake
          else
            make -j4
          fi

      - name: Запуск тестов
        run: |
          cd build
          if [ "$RUNNER_OS" = "Windows" ]; then
            .\StringOperations.exe --test
          else
            ./StringOperations --test
          fi

      - name: Загрузка артефактов
        uses: actions/upload-artifact@v4
        with:
          name: stringops-${{ runner.os }}
          path: |
            build/StringOperations
            build/StringOperations.exe

  build:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Установка Qt5
        uses: jurplel/install-qt-action@v3
        with:
          version: "5.15.2"
          host: linux
          target: desktop

      - name: Сборка релизной версии
        run: |
          mkdir -p release
          cd release
          qmake ../StringOperations.pro "CONFIG+=release"
          make -j4
          strip StringOperations || true

      - name: Проверка бинарника
        run: |
          cd release
          file StringOperations
          ./StringOperations --demo
          echo "Размер бинарника:"
          ls -lh StringOperations

      - name: Сохранение релизного бинарника
        uses: actions/upload-artifact@v4
        with:
          name: stringops-release-linux
          path: release/StringOperations

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Скачать все артефакты
        uses: actions/download-artifact@v4

      - name: Проверка файлов
        run: |
          echo "Скачанные файлы:"
          find . -type f -name "StringOperations*" | xargs file
          echo "Содержимое артефактов:"
          ls -la */

      - name: Создание архива с релизами
        run: |
          mkdir -p releases
          find . -name "StringOperations*" -type f -exec cp {} releases/ \;
          tar -czf stringoperations-releases.tar.gz releases/
          ls -lh stringoperations-releases.tar.gz

      - name: Создание релиза на GitHub
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: stringoperations-releases.tar.gz
          draft: false
          prerelease: false
